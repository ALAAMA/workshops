<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>RCE Batch Processing Examples</title>
<!-- 2015-04-29 Wed 15:22 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Ista Zahn" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="http://tutorials.iq.harvard.edu/org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="http://tutorials.iq.harvard.edu/org-html-themes/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">RCE Batch Processing Examples</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. R Batch Processing Examples</a>
<ul>
<li><a href="#sec-1-1">1.1. Batch example: Simple power simulation in R</a>
<ul>
<li><a href="#sec-1-1-1">1.1.1. R power simulation script</a></li>
<li><a href="#sec-1-1-2">1.1.2. Submit file</a></li>
<li><a href="#sec-1-1-3">1.1.3. Monitoring submitted jobs</a></li>
<li><a href="#sec-1-1-4">1.1.4. Aggregating results</a></li>
<li><a href="#sec-1-1-5">1.1.5. Try it yourself!</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-2">2. Batch example: Power simulation in R with varying parameters</a>
<ul>
<li><a href="#sec-2-1">2.1. Submit file passing process as an argument</a></li>
<li><a href="#sec-2-2">2.2. R script argument processing</a></li>
<li><a href="#sec-2-3">2.3. Aggregating results</a></li>
<li><a href="#sec-2-4">2.4. Try it yourself!</a></li>
</ul>
</li>
<li><a href="#sec-3">3. <span class="todo TODO">TODO</span> Stata Batch Processing Examples</a></li>
<li><a href="#sec-4">4. <span class="todo TODO">TODO</span> Python Batch Processing Examples</a></li>
<li><a href="#sec-5">5. <span class="todo TODO">TODO</span> Matlab Batch Processing Examples</a></li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> R Batch Processing Examples</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Batch example: Simple power simulation in R</h3>
<div class="outline-text-3" id="text-1-1">
<p>
The simplest kind of batch job is one for which you just want to run the same code multiple times, without varying any parameters. For example, suppose that we wish to run a power simulation for a t.test with unequal group sizes. 
</p>
</div>

<div id="outline-container-sec-1-1-1" class="outline-4">
<h4 id="sec-1-1-1"><span class="section-number-4">1.1.1</span> R power simulation script</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
The first step is to write a script or program to carry out the desired computation. The R script below simulates distributions with a specified mean difference, performs two-sample t-tests on the difference, and calculates the proportion of significant tests.
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">function to simulate data and perform a t.test</span>
<span style="color: #006699;">sim.ttest</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span><span style="color: #006FE0;">(</span>mu1, mu2, sd, n1, n2<span style="color: #006FE0;">)</span> <span style="color: #006FE0;">{</span>
    d <span style="color: #D0372D;">&lt;-</span> <span style="color: #006699;">data.frame</span><span style="color: #006FE0;">(</span>x <span style="color: #D0372D;">=</span> <span style="color: #006699;">c</span><span style="color: #006FE0;">(</span><span style="color: #006699;">rep</span><span style="color: #006FE0;">(</span><span style="color: #008000;">"group1"</span>, n1<span style="color: #006FE0;">)</span>, <span style="color: #006699;">rep</span><span style="color: #006FE0;">(</span><span style="color: #008000;">"group2"</span>, n2<span style="color: #006FE0;">))</span>,
                    y <span style="color: #D0372D;">=</span> <span style="color: #006699;">c</span><span style="color: #006FE0;">(</span><span style="color: #006699;">rnorm</span><span style="color: #006FE0;">(</span>n1, mean <span style="color: #D0372D;">=</span> mu1, sd <span style="color: #D0372D;">=</span> sd<span style="color: #006FE0;">)</span>,
                          <span style="color: #006699;">rnorm</span><span style="color: #006FE0;">(</span>n2, mean <span style="color: #D0372D;">=</span> mu2, sd <span style="color: #D0372D;">=</span> sd<span style="color: #006FE0;">)))</span>
    <span style="color: #0000FF;">return</span><span style="color: #006FE0;">(</span><span style="color: #006699;">t.test</span><span style="color: #006FE0;">(</span>y ~ x, data <span style="color: #D0372D;">=</span> d<span style="color: #006FE0;">)</span>$p.value<span style="color: #006FE0;">)</span>
<span style="color: #006FE0;">}</span>

<span style="color: #8D8D84;">##  </span><span style="color: #8D8D84; font-style: italic;">run the function 10,000 times </span>
p <span style="color: #D0372D;">&lt;-</span> <span style="color: #006699;">replicate</span><span style="color: #006FE0;">(</span><span style="color: #6434A3;">10000</span>,
               <span style="color: #006699;">sim.ttest</span><span style="color: #006FE0;">(</span>mu1 <span style="color: #D0372D;">=</span> <span style="color: #6434A3;">1</span>,
                         mu2 <span style="color: #D0372D;">=</span> <span style="color: #6434A3;">1.3</span>,
                         sd <span style="color: #D0372D;">=</span> <span style="color: #6434A3;">1</span>,
                         n1 <span style="color: #D0372D;">=</span> <span style="color: #6434A3;">50</span>,
                         n2 <span style="color: #D0372D;">=</span> <span style="color: #6434A3;">150</span><span style="color: #006FE0;">))</span>
<span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">calculate the proportion of significant tests</span>
<span style="color: #006699;">cat</span><span style="color: #006FE0;">(</span><span style="color: #006699;">length</span><span style="color: #006FE0;">(</span>p<span style="color: #006FE0;">[</span>p <span style="color: #D0372D;">&lt;</span> <span style="color: #6434A3;">.05</span><span style="color: #006FE0;">])</span><span style="color: #D0372D;">/</span><span style="color: #006699;">length</span><span style="color: #006FE0;">(</span>p<span style="color: #006FE0;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-1-2" class="outline-4">
<h4 id="sec-1-1-2"><span class="section-number-4">1.1.2</span> Submit file</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
If we want to run this function one million times it may take a while, especially if our computer is an older less powerful model. So let's run it on 100 separate machines (each one will simulate the test 10000 times). To do that we need, in addition to the R script above, a submit file to request resources and run the computation. 
</p>
<div class="org-src-container">

<pre class="src src-conf"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Universe whould always be 'vanilla'. This line MUST be </span>
<span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">included in your submit file, exactly as shown below.</span>
<span style="color: #BA36A5;">Universe</span> = vanilla

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Enter the path to the R program.</span>
<span style="color: #BA36A5;">Executable</span> = /usr/local/bin/R

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Specify any arguments you want to pass to the executable</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">to make r not save or restore workspaces, and to </span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">run as quietly as possible</span>
<span style="color: #BA36A5;">Arguments</span> = --no-save --no-restore --slave

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Specify the relative path to the input file</span>
<span style="color: #BA36A5;">input</span> = power.R

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Specify where to output any results printed by your program.</span>
<span style="color: #BA36A5;">output</span> = output/out.$(Process)
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Specify where to save any errors returned by your program.</span>
<span style="color: #BA36A5;">error</span> = output/error.$(Process)
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Specify where to save the log file.</span>
<span style="color: #BA36A5;">Log</span> = output/log
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Enter the number of processes to request.</span>
Queue 100
</pre>
</div>

<p>
Now that we have our script and the submit file we can run submit the job as follows:
</p>
<ol class="org-ol">
<li>make a project folder for this run if it doesn't exist
</li>
<li>save the R script (as power.R) and the submit file (as power.submit) in the project folder
</li>
<li>make a sub folder named <code>output</code>
</li>
<li>open a terminal and <code>cd</code> to the project folder
</li>
<li>run <code>condor_submit power.submit</code> to submit the jobs to the cluster
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-1-1-3" class="outline-4">
<h4 id="sec-1-1-3"><span class="section-number-4">1.1.3</span> Monitoring submitted jobs</h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
After submitting the jobs we may wish to monitor them, e.g. to check if they are running. You can do this by running <code>condor_q &lt;your_user_name&gt;</code> in a terminal. If this returns nothing then you have no jobs in the queue. Otherwise you will see information for each request in the queue which will look something like this:
</p>
<pre class="example">
-- Schedd: HMDC.batch@rce6-5.hmdc.harvard.edu : &lt;10.0.0.10:9619?sock=7858_e19e_247&gt;
 ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD               
 200.0   izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.1   izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.2   izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.3   izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.4   izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.5   izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.6   izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.7   izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.8   izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.9   izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.10  izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.11  izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.12  izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
</pre>
<p>
Perhaps the most important information returned by <code>condor_q</code> is the program status (the <b>ST</b> column). Status <b>I</b> means your job is in the queue but has not yet started running, <b>R</b> means the job is currently running, and <b>H</b> means the job is on hold. If you job is on hold you can get more information about what the problem might be by running <code>condor_q -hold</code>.
</p>

<p>
You will know your job is finished when it is no longer listed in the <code>condor_q</code> output. When it finishes you can examine the output and/or error files to see if the program exited successfully.
</p>
</div>
</div>

<div id="outline-container-sec-1-1-4" class="outline-4">
<h4 id="sec-1-1-4"><span class="section-number-4">1.1.4</span> Aggregating results</h4>
<div class="outline-text-4" id="text-1-1-4">
<p>
When your batch job is finished you are usually left with multiple output files that need to be aggregated. In the case of our simulation example, we have files <code>output/out.0 -- output/out40</code>, each of which contains a single number representing the proportion of significant tests. We can aggregate them with a simple R script, like this:
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">list all output files in the output directory</span>
output_files <span style="color: #D0372D;">&lt;-</span> <span style="color: #006699;">list.files</span><span style="color: #006FE0;">(</span><span style="color: #008000;">"output"</span>,
                           pattern <span style="color: #D0372D;">=</span> <span style="color: #008000;">"^out\\.[0-9]+$"</span>,
                           full.names<span style="color: #D0372D;">=</span><span style="color: #6434A3;">TRUE</span><span style="color: #006FE0;">)</span>

<span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">read each file, convert it to a number, and take the average</span>
<span style="color: #006699;">mean</span><span style="color: #006FE0;">(</span><span style="color: #006699;">as.double</span><span style="color: #006FE0;">(</span><span style="color: #006699;">sapply</span><span style="color: #006FE0;">(</span>
                      output_files,
                      readLines,
                      warn <span style="color: #D0372D;">=</span> <span style="color: #6434A3;">FALSE</span><span style="color: #006FE0;">)))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-1-5" class="outline-4">
<h4 id="sec-1-1-5"><span class="section-number-4">1.1.5</span> Try it yourself!</h4>
<div class="outline-text-4" id="text-1-1-5">
<p>
Download the <a href="R_examples/power1.zip">power simulation example files</a>, to the RCE, extract the zip file and running <code>condor_submit power.submit</code> in the <code>power1</code> directory.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Batch example: Power simulation in R with varying parameters</h2>
<div class="outline-text-2" id="text-2">
<p>
The previous example was relatively simple, because we wanted to run exactly the same code on all 100 nodes. Often however you want each node to do something slightly different. For example, we may wish to vary the sample size from 100 &#x2013; 500 in increments of 10, to see how power changes as a function of that parameter. In that case we need to pass some additional information to each process, telling it which parameter space it is responsible for. 
</p>

<p>
As it turns out, we almost already know how to do that: if you you look closely at the submit file in the previous example you will notice that we used <code>$(Process)</code> to append the process number to the output and error files. 
</p>
</div>
<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Submit file passing process as an argument</h3>
<div class="outline-text-3" id="text-2-1">
<p>
We can use the <code>$(Process)</code> macro to pass information to our program, like this:
</p>
<div class="org-src-container">

<pre class="src src-conf"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Universe whould always be 'vanilla'. This line MUST be </span>
<span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">included in your submit file, exactly as shown below.</span>
<span style="color: #BA36A5;">Universe</span> = vanilla

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Enter the path to the R program.</span>
<span style="color: #BA36A5;">Executable</span> = /usr/local/bin/R

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Specify any arguments you want to pass to the executable</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">to make r not save or restore workspaces, and to </span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">run as quietly as possible</span>
<span style="color: #BA36A5;">Arguments</span> = --no-save --no-restore --slave --args $(Process)

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Specify the relative path to the input file</span>
<span style="color: #BA36A5;">input</span> = power.R

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Specify where to save any errors returned by your program.</span>
<span style="color: #BA36A5;">error</span> = output/error.$(Process)

<span style="color: #BA36A5;">Log</span> = log.txt
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Enter the number of processes to request.</span>
Queue 40
</pre>
</div>
<p>
Notice that we used <code>--args $(Process)</code> to pass the process number to the R program. <code>$(Process)</code> will be an integer starting from <code>0</code>. 
</p>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> R script argument processing</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Next we need to 1) retrieve the process number in our R program and 2) map it to the parameter space. We can retrieve the arguments in R like this:
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">retrieve arguments passed from the command line.</span>
process <span style="color: #D0372D;">&lt;-</span> <span style="color: #006699;">as.integer</span><span style="color: #006FE0;">(</span><span style="color: #006699;">as.character</span><span style="color: #006FE0;">(</span><span style="color: #006699;">commandArgs</span><span style="color: #006FE0;">(</span>trailingOnly <span style="color: #D0372D;">=</span> <span style="color: #6434A3;">TRUE</span><span style="color: #006FE0;">)))</span>
</pre>
</div>
<p>
We now have a variable in R that tells us which process we are. Now we need to map that to our parameter space; recall that we want to test sample sizes from 100 to 500, so we need to map <code>process 0</code> to <code>n = 100</code>,  <code>process 1</code> to <code>n = 110</code>, <code>process 2</code> to <code>n = 120</code> and so on:
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">map process to sample size parameter.</span>
n <span style="color: #D0372D;">&lt;-</span> <span style="color: #006FE0;">(</span>process <span style="color: #D0372D;">+</span> <span style="color: #6434A3;">100</span><span style="color: #006FE0;">)</span> <span style="color: #D0372D;">+</span> <span style="color: #006FE0;">(</span>process*<span style="color: #6434A3;">10</span> <span style="color: #D0372D;">-</span> process<span style="color: #006FE0;">)</span>
</pre>
</div>

<pre class="example">
Error: object 'process' not found
</pre>

<p>
There is one additional complication we need to handle: in the previous example we did need to keep track of the parameters used by each process because the parameters did not vary. Now that they do, it would be nice if we had output that recorded the value of the varying parameter as well as the result. We could of course just print the <code>n</code> parameter we calculated from the process number along with the result, but it will be easier to combine the outputs if we write them to a machine-readable format (e.g., a comma-separated-values file). You may have noticed that in the submit file above I omitted the <code>output</code> directive: that is because we are going to explicitly save the results in the R script, so we don't need the batch scheduler to save those output files for us.
</p>

<p>
Now we can set up the simulation as before, passing the <code>n</code> calculated above into our simulation function, writing the results to files. 
</p>
<div class="org-src-container">

<pre class="src src-R">  <span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">function to simulate data and perform a t.test</span>
  <span style="color: #006699;">sim.ttest</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span><span style="color: #006FE0;">(</span>mu1, mu2, sd, n1, n2<span style="color: #006FE0;">)</span> <span style="color: #006FE0;">{</span>
      d <span style="color: #D0372D;">&lt;-</span> <span style="color: #006699;">data.frame</span><span style="color: #006FE0;">(</span>x <span style="color: #D0372D;">=</span> <span style="color: #006699;">c</span><span style="color: #006FE0;">(</span><span style="color: #006699;">rep</span><span style="color: #006FE0;">(</span><span style="color: #008000;">"group1"</span>, n1<span style="color: #006FE0;">)</span>, <span style="color: #006699;">rep</span><span style="color: #006FE0;">(</span><span style="color: #008000;">"group2"</span>, n2<span style="color: #006FE0;">))</span>,
                      y <span style="color: #D0372D;">=</span> <span style="color: #006699;">c</span><span style="color: #006FE0;">(</span><span style="color: #006699;">rnorm</span><span style="color: #006FE0;">(</span>n1, mean <span style="color: #D0372D;">=</span> mu1, sd <span style="color: #D0372D;">=</span> sd<span style="color: #006FE0;">)</span>,
                            <span style="color: #006699;">rnorm</span><span style="color: #006FE0;">(</span>n2, mean <span style="color: #D0372D;">=</span> mu2, sd <span style="color: #D0372D;">=</span> sd<span style="color: #006FE0;">)))</span>
      <span style="color: #0000FF;">return</span><span style="color: #006FE0;">(</span><span style="color: #006699;">t.test</span><span style="color: #006FE0;">(</span>y ~ x, data <span style="color: #D0372D;">=</span> d<span style="color: #006FE0;">)</span>$p.value<span style="color: #006FE0;">)</span>
  <span style="color: #006FE0;">}</span>

  <span style="color: #8D8D84;">##  </span><span style="color: #8D8D84; font-style: italic;">run the function 10,000 times </span>
  p <span style="color: #D0372D;">&lt;-</span> <span style="color: #006699;">replicate</span><span style="color: #006FE0;">(</span><span style="color: #6434A3;">10000</span>,
                 <span style="color: #006699;">sim.ttest</span><span style="color: #006FE0;">(</span>mu1 <span style="color: #D0372D;">=</span> <span style="color: #6434A3;">1</span>,
                           mu2 <span style="color: #D0372D;">=</span> <span style="color: #6434A3;">1.3</span>,
                           sd <span style="color: #D0372D;">=</span> <span style="color: #6434A3;">1</span>,
                           n1 <span style="color: #D0372D;">=</span> n,
                           n2 <span style="color: #D0372D;">=</span> n<span style="color: #006FE0;">))</span>
<span style="color: #006699;">write.csv</span><span style="color: #006FE0;">(</span><span style="color: #006699;">data.frame</span><span style="color: #006FE0;">(</span>n <span style="color: #D0372D;">=</span> n, power <span style="color: #D0372D;">=</span> <span style="color: #006699;">length</span><span style="color: #006FE0;">(</span>p<span style="color: #006FE0;">[</span>p <span style="color: #D0372D;">&lt;</span> <span style="color: #6434A3;">.05</span><span style="color: #006FE0;">])</span><span style="color: #D0372D;">/</span><span style="color: #006699;">length</span><span style="color: #006FE0;">(</span>p<span style="color: #006FE0;">))</span>,
          row.names <span style="color: #D0372D;">=</span> <span style="color: #6434A3;">FALSE</span>,
          file <span style="color: #D0372D;">=</span> <span style="color: #006699;">paste0</span><span style="color: #006FE0;">(</span><span style="color: #008000;">"output/out"</span>, process, <span style="color: #008000;">".csv"</span><span style="color: #006FE0;">))</span>
</pre>
</div>

<p>
Now we have all the required elements to submit out job, and can do so using <code>condor_submit</code> as before. 
</p>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> Aggregating results</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Each of our 40 processes produced a file in the <code>output</code> directory name <code>out&lt;process&gt;csv</code>; our next task is to aggregate these results. The R script below reads each of these files, joins them together into a single data.frame, and plots the result.
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">list all output files in the output directory</span>
output_files <span style="color: #D0372D;">&lt;-</span> <span style="color: #006699;">list.files</span><span style="color: #006FE0;">(</span><span style="color: #008000;">"output"</span>,
                           pattern <span style="color: #D0372D;">=</span> <span style="color: #008000;">"^out[0-9]+\\.csv$"</span>,
                           full.names<span style="color: #D0372D;">=</span><span style="color: #6434A3;">TRUE</span><span style="color: #006FE0;">)</span>

<span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">read each file and append them</span>
results <span style="color: #D0372D;">&lt;-</span> <span style="color: #006699;">do.call</span><span style="color: #006FE0;">(</span>rbind, <span style="color: #006699;">lapply</span><span style="color: #006FE0;">(</span>output_files, read.csv<span style="color: #006FE0;">))</span>

<span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">plot</span>
<span style="color: #006699;">plot</span><span style="color: #006FE0;">(</span>results<span style="color: #006FE0;">)</span>
<span style="color: #006699;">abline</span><span style="color: #006FE0;">(</span>h <span style="color: #D0372D;">=</span> <span style="color: #6434A3;">0.8</span><span style="color: #006FE0;">)</span>
</pre>
</div>


<div class="figure">
<p><img src="R_examples/images/powerDist.png" alt="powerDist.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4"><span class="section-number-3">2.4</span> Try it yourself!</h3>
<div class="outline-text-3" id="text-2-4">
<p>
Download the <a href="R_examples/power2.zip">power simulation example files</a>, to the RCE, extract the zip file, and run the example by calling <code>condor_submit power.submit</code> from the <code>power2</code> directory.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> <span class="todo TODO">TODO</span> Stata Batch Processing Examples</h2>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> <span class="todo TODO">TODO</span> Python Batch Processing Examples</h2>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> <span class="todo TODO">TODO</span> Matlab Batch Processing Examples</h2>
</div>
</div>
<div id="postamble" class="status">
<h3><a href='../RCEintro.html'> Back to RCE Quick-Start Guide</a></h3>
</div>
</body>
</html>
